from typing import List, Dict, Any
import os
from openai import AsyncOpenAI

class AIService:
    def __init__(self):
        self.api_key = os.getenv("OPENROUTER_API_KEY")
        self.model = os.getenv("AI_MODEL", "openai/gpt-oss-120b:exacto")
        self.base_url = "https://openrouter.ai/api/v1"
        
        if self.api_key:
            self.client = AsyncOpenAI(api_key=self.api_key, base_url=self.base_url)
        else:
            self.client = None
            print("Warning: OPENROUTER_API_KEY not set.")

    async def get_product_recommendation(
        self, 
        user_query: str, 
        history: List[Dict[str, str]], 
        product_catalog: List[Dict[str, Any]],
        system_prompt: str = None,
        language: str = "ru",
        lead_name: str = None,
        lead_phone: str = None
    ) -> str:

        if not system_prompt:
            # Lead context
            lead_info = f"""
–°–û–ë–†–ê–ù–ù–´–ï –î–ê–ù–ù–´–ï:
- –ò–º—è: {lead_name if lead_name else "–Ω–µ—Ç"}
- –¢–µ–ª–µ—Ñ–æ–Ω: {lead_phone if lead_phone else "–Ω–µ—Ç"}
"""
            
            print(f"üîç AI Context: name={lead_name}, phone={lead_phone}")
            
            system_prompt = f"""{lead_info}

–¢—ã ‚Äî AI –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏ BizDNAi.

–û –ö–û–ú–ü–ê–ù–ò–ò: –ú—ã –≤–Ω–µ–¥—Ä—è–µ–º AI —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (CRM, —á–∞—Ç-–±–æ—Ç—ã, –≥–æ–ª–æ—Å–æ–≤—ã–µ –ø–æ–º–æ—â–Ω–∏–∫–∏, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞).

–°–¢–†–ê–¢–ï–ì–ò–Ø:
1. –ü–ï–†–í–´–ô –ö–û–ù–¢–ê–ö–¢: "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ö–∞–∫–∞—è —Å—Ñ–µ—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏?"
2. –ö–õ–ò–ï–ù–¢ –ù–ê–ó–í–ê–õ –°–§–ï–†–£: "–û—Ç–ª–∏—á–Ω–æ! –•–æ—Ç–∏—Ç–µ –ª–∏ —É–ª—É—á—à–∏—Ç—å –µ—â–µ —á—Ç–æ-—Ç–æ? –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–¥–∞–∂–∏ –∏–ª–∏ —Ñ–∏–Ω–∞–Ω—Å—ã."
3. –ö–õ–ò–ï–ù–¢ –°–ö–ê–ó–ê–õ "–ù–ï–¢":
   - –ï—Å–ª–∏ –ù–ï–¢ –∏–º–µ–Ω–∏: "–ö–∞–∫ –∫ –≤–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è?"
   - –ï—Å–ª–∏ –µ—Å—Ç—å –∏–º—è, –ù–ï–¢ —Ç–µ–ª–µ—Ñ–æ–Ω–∞: "–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏ [REQUEST_CONTACT]"

–ü–†–ê–í–ò–õ–ê:
- –û—Ç–≤–µ—Ç—ã –ö–†–ê–¢–ö–ò–ï (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- –ï—Å–ª–∏ –û–ë–ê –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Å–æ–±—Ä–∞–Ω—ã ‚Üí –ø–æ–∫–∞–∂–∏ "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ: –ò–º—è: [–∏–º—è], –¢–µ–ª–µ—Ñ–æ–Ω: [—Ç–µ–ª–µ—Ñ–æ–Ω]. –í—Å—ë –≤–µ—Ä–Ω–æ?"
- –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ –∫–æ–º–ø–∞–Ω–∏–∏ - –æ—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –æ –Ω–∞—Å
- [REQUEST_CONTACT] –¥–æ–±–∞–≤–ª—è–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
- –ù–ï —Å–ø—Ä–∞—à–∏–≤–∞–π –∫–æ–Ω—Ç–∞–∫—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –£–ñ–ï –µ—Å—Ç—å
- –ü–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö ("–¥–∞") ‚Üí —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç –¥–∏–∞–ª–æ–≥

–Ø–ó–´–ö: {language}"""

        messages = [{"role": "system", "content": system_prompt}]
        
        recent_history = history[-30:] if len(history) > 30 else history
        
        for msg in recent_history:
            role = "user" if msg.get("sender") == "user" else "assistant"
            messages.append({"role": role, "content": msg.get("text", "")})
            
        messages.append({"role": "user", "content": user_query})

        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                max_tokens=500,
                temperature=0.3,
                extra_headers={
                    "HTTP-Referer": "https://bizdnaii.com",
                    "X-Title": "BizDNAii Sales Agent"
                }
            )
            
            answer = response.choices[0].message.content
            
            if not answer or answer.strip() == "":
                return "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–∞—è —Å—Ñ–µ—Ä–∞ –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç—Ä–µ–±—É–µ—Ç —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∞—Ü–∏–∏?"
            
            return answer.strip().replace('\\n', '\n')
            
        except Exception as e:
            print(f"Error calling AI: {e}")
            return "–î–æ–±—Ä—ã–π –¥–µ–Ω—å! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –±–∏–∑–Ω–µ—Å–µ."

    async def generate_conversation_summary(self, history: List[Dict[str, str]], language: str = "ru") -> str:
        if not self.client or not history:
            return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

        summary_prompt = """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∏–∞–ª–æ–≥ –∏ —Å–æ—Å—Ç–∞–≤—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
–ò–≥–Ω–æ—Ä–∏—Ä—É–π –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–ø–∞—Å–∏–±–æ, –Ω–æ–º–µ—Ä –ø–æ–ª—É—á–µ–Ω).
–§–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ —Å—É—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞.

–°–¢–†–£–ö–¢–£–†–ê –û–¢–ß–ï–¢–ê:
1. **–ò–Ω—Ç–µ—Ä–µ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞** (–ø–µ—Ä–µ—á–∏—Å–ª–∏ –≤—Å–µ –Ω–∞–∑–≤–∞–Ω–Ω—ã–µ —Å—Ñ–µ—Ä—ã)
2. **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å** (–•–æ–ª–æ–¥–Ω—ã–π/–¢–µ–ø–ª—ã–π/–ì–æ—Ä—è—á–∏–π - –æ–±—ä—è—Å–Ω–∏ –ø–æ—á–µ–º—É)
3. **–ë–æ–ª–∏/–ó–∞–¥–∞—á–∏** (—á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—á–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å)
4. **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è** (–∫–∞–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å, —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∑–≤–æ–Ω–∫–∞)

–û–±—ä–µ–º: 150-200 —Å–ª–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π Markdown."""

        messages = [{"role": "system", "content": summary_prompt}]
        
        for msg in history:
            role = "user" if msg.get("sender") == "user" else "assistant"
            messages.append({"role": role, "content": msg.get("text", "")})

        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                max_tokens=1000,
                temperature=0.3
            )
            return response.choices[0].message.content or "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
        except:
            return "–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–≤–æ–¥–∫–∏"

    async def extract_contact_info(self, history: List[Dict[str, str]]) -> Dict[str, str]:
        """
        Extracts Name and Phone from conversation history using LLM.
        Returns dict with 'name' and 'phone' keys (values can be None).
        """
        if not self.client or not history:
            return {"name": None, "phone": None}

        extraction_prompt = """Analyze the conversation and extract the user's Name and Phone number.
        
        Rules:
        1. Name: Look for self-introduction or response to "What is your name?".
        2. Phone: Look for 10-12 digit number (ignoring spaces/dashes).
        3. Output JSON ONLY: {"name": "...", "phone": "..."}
        4. If missing, use null.
        """

        messages = [{"role": "system", "content": extraction_prompt}]
        
        # Use last 10 messages for context
        for msg in history[-10:]:
            role = "user" if msg.get("sender") == "user" else "assistant"
            messages.append({"role": role, "content": msg.get("text", "")})

        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                max_tokens=100,
                temperature=0.1,
                response_format={"type": "json_object"}
            )
            import json
            content = response.choices[0].message.content
            # Cleanup json markdown if present
            if "```json" in content:
                content = content.split("```json")[1].split("```")[0]
            elif "```" in content:
                content = content.split("```")[1].split("```")[0]
                
            data = json.loads(content)
            return {
                "name": data.get("name"), 
                "phone": data.get("phone")
            }
        except Exception as e:
            print(f"Extraction error: {e}")
            return {"name": None, "phone": None}

    async def process_manager_command(self, command: str) -> str:
        """
        Process text command from manager and generate intelligent response.
        Handles commands like: status check, reports, analytics, help, etc.
        """
        if not self.client:
            return "‚ö†Ô∏è AI —Å–µ—Ä–≤–∏—Å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç OPENROUTER_API_KEY)"
        
        system_prompt = """–¢—ã ‚Äî AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–æ–π BizDNAi Sales Agent.

–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–¥–∞—Ç—å —Ç–µ–±–µ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∏–ª–∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ.

–î–û–°–¢–£–ü–ù–´–ï –ö–û–ú–ê–ù–î–´:
- –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã / –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏–¥–∞—Ö –∏ –æ—Ç—á–µ—Ç–∞—Ö
- –ü–æ–º–æ—â—å –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
- –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ –±–æ—Ç–µ

–°–¢–ò–õ–¨ –û–¢–í–ï–¢–ê:
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –∫—Ä–∞—Ç–∫–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏
- –§–æ—Ä–º–∞—Ç–∏—Ä—É–π —Ç–µ–∫—Å—Ç —Å –ø–æ–º–æ—â—å—é HTML —Ç–µ–≥–æ–≤ Telegram (<b>, <i>, <code>)
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ç–æ–º —è–∑—ã–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–¥–∞–Ω –≤–æ–ø—Ä–æ—Å

–ü–†–ò–ú–ï–†–´ –û–¢–í–ï–¢–û–í:

Q: "–°—Ç–∞—Ç—É—Å"
A: "‚úÖ <b>–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç</b>

ü§ñ AI –∞–≥–µ–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω
üì± Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã
üìß Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
üåê –í–µ–±-–≤–∏–¥–∂–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω

–í—Å–µ —Å–∏—Å—Ç–µ–º—ã —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É—é—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ!"

Q: "–ü–æ–º–æ—â—å"
A: "üìã <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>

<b>–°—Ç–∞—Ç—É—Å</b> - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã
<b>–û—Ç—á–µ—Ç—ã</b> - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª–∏–¥–∞—Ö
<b>–ü–æ–º–æ—â—å</b> - —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥

–ú–æ–∂–µ—à—å —Ç–∞–∫–∂–µ –∑–∞–¥–∞—Ç—å –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –æ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞!"
"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": command}
        ]

        try:
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                max_tokens=500,
                temperature=0.7,
                extra_headers={
                    "HTTP-Referer": "https://bizdnaii.com",
                    "X-Title": "BizDNAii Manager Assistant"
                }
            )
            
            answer = response.choices[0].message.content
            
            if not answer or answer.strip() == "":
                return "üëã –ü—Ä–∏–≤–µ—Ç! –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
            
            return answer.strip()
            
        except Exception as e:
            print(f"Error processing manager command: {e}")
            return f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã: {str(e)}"

ai_service = AIService()
