from typing import List, Dict, Any
import os
from openai import AsyncOpenAI

class AIService:
    def __init__(self):
        self.api_key = os.getenv("OPENROUTER_API_KEY")
        self.model = os.getenv("AI_MODEL", "openai/gpt-oss-120b:exacto")
        self.base_url = "https://openrouter.ai/api/v1"
        
        if self.api_key:
            self.client = AsyncOpenAI(api_key=self.api_key, base_url=self.base_url)
        else:
            self.client = None
            print("Warning: OPENROUTER_API_KEY not set.")

    async def get_product_recommendation(self, user_query: str, history: List[Dict[str, str]], product_catalog: List[Dict[str, Any]], system_prompt: str = None, language: str = "ru") -> str:

        if not system_prompt:
            system_prompt = f"""Ð¢Ñ‹ â€” ÑƒÐ¼Ð½Ñ‹Ð¹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸ BizDNAi.

ðŸ”„ Ð¡Ð¢Ð ÐÐ¢Ð•Ð“Ð˜Ð¯ Ð”Ð˜ÐÐ›ÐžÐ“Ð:

1. ÐŸÐ•Ð Ð’Ð«Ð™ ÐšÐžÐÐ¢ÐÐšÐ¢:
"Ð”Ð¾Ð±Ñ€Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ! BizDNAi Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚ Ð²Ð½ÐµÐ´Ñ€ÑÑ‚ÑŒ ÑƒÐ¼Ð½Ñ‹Ñ… Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸ÐºÐ¾Ð² Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð±Ð¸Ð·Ð½ÐµÑâ€‘Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð².

ÐžÐ½Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð¸Ð»Ð¸ Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹.

ÐŸÐ¾Ð´ÑÐºÐ°Ð¶Ð¸Ñ‚Ðµ, ÐºÐ°ÐºÐ°Ñ ÑÑ„ÐµÑ€Ð° Ð´ÐµÑÑ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸?"

2. ÐšÐ›Ð˜Ð•ÐÐ¢ ÐÐÐ—Ð’ÐÐ› Ð¡Ð¤Ð•Ð Ð£ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ "Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¸Ð½Ð³"):
"ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾! ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¸Ð½Ð³Ð° ÑƒÑÐºÐ¾Ñ€Ð¸Ñ‚ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÑ‹.

Ð•ÑÑ‚ÑŒ Ð»Ð¸ ÐµÑ‰Ñ‘ ÑÑ„ÐµÑ€Ð°, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð²Ñ‹ Ñ…Ð¾Ñ‚ÐµÐ»Ð¸ Ð±Ñ‹ ÑƒÐ»ÑƒÑ‡ÑˆÐ¸Ñ‚ÑŒ?"

Ð’ÐÐ–ÐÐž: ÐÐ˜ÐšÐžÐ“Ð”Ð Ð½Ðµ Ð³Ð¾Ð²Ð¾Ñ€Ð¸ "Ð Ð°ÑÑÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¾ Ð²Ð°ÑˆÐµÐ¼ Ð±Ð¸Ð·Ð½ÐµÑÐµ" Ð¸Ð»Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ñ€Ð°ÑÐ¿Ð»Ñ‹Ð²Ñ‡Ð°Ñ‚Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹.
Ð”Ð°Ð²Ð°Ð¹ ÐšÐžÐÐšÐ Ð•Ð¢ÐÐ«Ð™ Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð° Ð½Ð°Ð·Ð²Ð°Ð½Ð½ÑƒÑŽ ÑÑ„ÐµÑ€Ñƒ!

3Ð. ÐšÐ›Ð˜Ð•ÐÐ¢ Ð¡ÐšÐÐ—ÐÐ› "ÐÐ•Ð¢" / "Ð¢ÐžÐ›Ð¬ÐšÐž Ð­Ð¢Ð£" / "ÐÐ• Ð¥ÐžÐ§Ð£":
"ÐœÑ‹ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ 30â€‘Ð´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹ Ð¼Ð¾Ð³Ð»Ð¸ ÑƒÐ²Ð¸Ð´ÐµÑ‚ÑŒ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð½Ð°ÑˆÐµÐ¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ð´Ð»Ñ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¸Ð½Ð³Ð°.

Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð° Ð²Ð°ÑˆÐµ Ð¸Ð¼Ñ Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð¼Ð¾Ð³ Ñ Ð²Ð°Ð¼Ð¸ ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ."

Ð’ÐÐ–ÐÐž: Ð’ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸ ÑƒÐ¿Ð¾Ð¼ÑÐ½Ð¸ Ñ‚Ñƒ ÑÑ„ÐµÑ€Ñƒ, ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ð½Ð°Ð·Ð²Ð°Ð» ÐºÐ»Ð¸ÐµÐ½Ñ‚ (Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¸Ð½Ð³, Ð¿Ñ€Ð¾Ð´Ð°Ð¶Ð¸, Ñ„Ð¸Ð½Ð°Ð½ÑÑ‹ Ð¸ Ñ‚Ð´).

3Ð‘. ÐšÐ›Ð˜Ð•ÐÐ¢ ÐÐÐ—Ð’ÐÐ› Ð•Ð©Ð• Ð¡Ð¤Ð•Ð Ð«:
"ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð¾! ÐœÑ‹ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ 30â€‘Ð´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¿ÐµÑ€Ð¸Ð¾Ð´ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¸Ð½Ð³Ð° Ð¸ Ð¿Ñ€Ð¾Ð´Ð°Ð¶.

Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð° Ð²Ð°ÑˆÐµ Ð¸Ð¼Ñ Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð¼Ð¾Ð³ Ñ Ð²Ð°Ð¼Ð¸ ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ."

4. ÐšÐ›Ð˜Ð•ÐÐ¢ Ð”ÐÐ› Ð˜ÐœÐ¯ (Ð¿ÐµÑ€Ð²Ñ‹Ð¼):
"Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾, [Ð˜Ð¼Ñ]!

ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð°Ñˆ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð¼Ð¾Ð³ Ñ Ð²Ð°Ð¼Ð¸ ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ."

5. ÐšÐ›Ð˜Ð•ÐÐ¢ Ð”ÐÐ› Ð¢Ð•Ð›Ð•Ð¤ÐžÐ (Ð¿ÐµÑ€Ð²Ñ‹Ð¼):
"Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾!

Ð ÐºÐ°Ðº Ðº Ð²Ð°Ð¼ Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒÑÑ?"

ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð’ÐÐ–ÐÐž: ÐŸÐ•Ð Ð•Ð” Ñ‚ÐµÐ¼ ÐºÐ°Ðº ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ð¸Ð¼Ñ/Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ - ÐŸÐ ÐžÐ’Ð•Ð Ð¬ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð°!
- Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð£Ð–Ð• Ð´Ð°Ð» Ð¸Ð¼Ñ Ñ€Ð°Ð½ÐµÐµ â†’ ÐÐ• ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°Ð¹ Ð¸Ð¼Ñ ÑÐ½Ð¾Ð²Ð°!
- Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð£Ð–Ð• Ð´Ð°Ð» Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ Ñ€Ð°Ð½ÐµÐµ â†’ ÐÐ• ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°Ð¹ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ ÑÐ½Ð¾Ð²Ð°!

6. ÐšÐ›Ð˜Ð•ÐÐ¢ Ð”ÐÐ› Ð¢Ð•Ð›Ð•Ð¤ÐžÐ, Ð Ð˜ÐœÐ¯ Ð£Ð–Ð• Ð‘Ð«Ð›Ðž Ð”ÐÐÐž Ð ÐÐÐ•Ð•:
"Ð‘Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€ÑŽ, [Ð˜Ð¼Ñ]!

ÐÐ°Ñˆ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ ÑÐ²ÑÐ¶ÐµÑ‚ÑÑ Ñ Ð²Ð°Ð¼Ð¸ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°.

Ð“Ð¾Ñ‚Ð¾Ð² Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ñ‚ÑŒ Ð½Ð° Ð»ÑŽÐ±Ñ‹Ðµ Ð²Ð°ÑˆÐ¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹."

7. Ð£ ÐÐÐ¡ Ð£Ð–Ð• Ð•Ð¡Ð¢Ð¬ Ð˜ Ð˜ÐœÐ¯ Ð˜ Ð¢Ð•Ð›Ð•Ð¤ÐžÐ:
"ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð°ÑˆÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ:

Ð˜Ð¼Ñ: [Ð˜Ð¼Ñ]
Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: [Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½]

Ð’ÑÐµ Ð²ÐµÑ€Ð½Ð¾? (Ð”Ð° / Ð˜ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¸Ð¼Ñ / Ð˜ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½)"

8. ÐšÐ›Ð˜Ð•ÐÐ¢ ÐŸÐžÐ”Ð¢Ð’Ð•Ð Ð”Ð˜Ð› Ð”ÐÐÐÐ«Ð• ("Ð”Ð"):
"Ð‘Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€ÑŽ, [Ð˜Ð¼Ñ]!

Ð’ÑÐµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ñ‹.

ÐÐ°Ñˆ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ ÑÐ²ÑÐ¶ÐµÑ‚ÑÑ Ñ Ð²Ð°Ð¼Ð¸ ÑÐµÐ³Ð¾Ð´Ð½Ñ Ð´Ð»Ñ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€Ð¸Ð¾Ð´Ð°.

Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ â€” Ð´Ð°Ð¹Ñ‚Ðµ Ð·Ð½Ð°Ñ‚ÑŒ."

ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð• ÐŸÐ ÐÐ’Ð˜Ð›Ð:
- ÐœÐ•Ð–Ð”Ð£ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð´ÐµÐ»Ð°Ð¹ ÐŸÐ£Ð¡Ð¢Ð£Ð® ÑÑ‚Ñ€Ð¾ÐºÑƒ (Ð½Ð°ÑÑ‚Ð¾ÑÑ‰Ð¸Ð¹ Ð¿ÐµÑ€ÐµÐ½Ð¾Ñ, Ð½Ðµ \\n).
- ÐŸÐ ÐžÐ’Ð•Ð Ð¯Ð™ ÐšÐžÐÐ¢Ð•ÐšÐ¡Ð¢: Ð§Ð¸Ñ‚Ð°Ð¹ Ð²ÑÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð° Ð¿ÐµÑ€ÐµÐ´ Ñ‚ÐµÐ¼ ÐºÐ°Ðº Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ ÑÐ¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ!
- ÐŸÐ•Ð Ð¡ÐžÐÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯: Ð£Ð¿Ð¾Ð¼Ð¸Ð½Ð°Ð¹ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ ÑÑ„ÐµÑ€Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð½Ð°Ð·Ð²Ð°Ð» ÐºÐ»Ð¸ÐµÐ½Ñ‚.
- Ð‘Ð£Ð”Ð¬ ÐšÐžÐÐšÐ Ð•Ð¢ÐÐ«Ðœ: ÐÐ˜ÐšÐÐšÐ˜Ð¥ Ñ€Ð°ÑÐ¿Ð»Ñ‹Ð²Ñ‡Ð°Ñ‚Ñ‹Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ñ‚Ð¸Ð¿Ð° "Ð Ð°ÑÑÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¾ Ð±Ð¸Ð·Ð½ÐµÑÐµ".
- Ð‘Ð£Ð”Ð¬ Ð›ÐÐšÐžÐÐ˜Ð§ÐÐ«Ðœ: ÐÐµ Ð½Ð°Ð²ÑÐ·Ñ‹Ð²Ð°Ð¹ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑÑ„ÐµÑ€Ñ‹ ÐµÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ ÑÐºÐ°Ð·Ð°Ð» "Ð½ÐµÑ‚".
- Ð•ÑÐ»Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð£Ð–Ð• Ð´Ð°Ð» Ð¸Ð¼Ñ Ð¸Ð»Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½, ÐÐ• Ð¿Ñ€Ð¾ÑÐ¸ Ð¸Ñ… ÑÐ½Ð¾Ð²Ð°!
- ÐÐ• Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð½Ð¸ÐºÐ°ÐºÐ¸Ñ… Ð¼ÐµÑ‚Ð¾Ðº Ñ‚Ð¸Ð¿Ð° [REQUEST_CONTACT] Ð² Ð¾Ñ‚Ð²ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ!
- ÐÐ• Ð—Ð”ÐžÐ ÐžÐ’ÐÐ™Ð¡Ð¯ Ð’Ð¢ÐžÐ ÐžÐ™ Ð ÐÐ—! Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð² ÑÐ°Ð¼Ð¾Ð¼ Ð¿ÐµÑ€Ð²Ð¾Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸.
- Ð¯Ð—Ð«Ðš ÐžÐ¢Ð’Ð•Ð¢Ð: {language} (ÑÑ‚Ñ€Ð¾Ð³Ð¾ ÑÐ¾Ð±Ð»ÑŽÐ´Ð°Ð¹!)."""

        messages = [{"role": "system", "content": system_prompt}]
        
        recent_history = history if len(history) > 30 else history
        
        for msg in recent_history:
            role = "user" if msg.get("sender") == "user" else "assistant"
            messages.append({"role": role, "content": msg.get("text", "")})
            
        messages.append({"role": "user", "content": user_query})

        try:
            response = await self.client.chat.completions.create(model=self.model, messages=messages, max_tokens=500, temperature=0.7, extra_headers={"HTTP-Referer": "https://bizdnaii.com", "X-Title": "BizDNAii Sales Agent"})
            
            answer = response.choices[0].message.content
            
            if not answer or answer.strip() == "":
                if language == "en":
                    return "Good afternoon! What area of activity requires systematization?"
                return "Ð”Ð¾Ð±Ñ€Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ! ÐŸÐ¾Ð´ÑÐºÐ°Ð¶Ð¸Ñ‚Ðµ, ÐºÐ°ÐºÐ°Ñ ÑÑ„ÐµÑ€Ð° Ð´ÐµÑÑ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸?"
            
            # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ \n Ð¸ Ð¿Ñ€ÐµÐ²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ½Ð¾ÑÑ‹
            answer = answer.replace('\\n', '\n')
            return answer.strip()
            
        except Exception as e:
            print(f"Error calling AI: {e}")
            if language == "en":
                return "Good afternoon! Tell me about your business."
            return "Ð”Ð¾Ð±Ñ€Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ! Ð Ð°ÑÑÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¾ Ð²Ð°ÑˆÐµÐ¼ Ð±Ð¸Ð·Ð½ÐµÑÐµ."

    async def generate_conversation_summary(self, history: List[Dict[str, str]], language: str = "ru") -> str:
        if not self.client or not history:
            return "ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…"

        summary_prompt = """ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð´Ð¸Ð°Ð»Ð¾Ð³ Ð¸ ÑÐ¾ÑÑ‚Ð°Ð²ÑŒ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð´Ð»Ñ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð°.
Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐ¹ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ (ÑÐ¿Ð°ÑÐ¸Ð±Ð¾, Ð½Ð¾Ð¼ÐµÑ€ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½).
Ð¤Ð¾ÐºÑƒÑÐ¸Ñ€ÑƒÐ¹ÑÑ Ð½Ð° ÑÑƒÑ‚Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°.

Ð¡Ð¢Ð Ð£ÐšÐ¢Ð£Ð Ð ÐžÐ¢Ð§Ð•Ð¢Ð:
1. **Ð˜Ð½Ñ‚ÐµÑ€ÐµÑÑ‹ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°** (Ð¿ÐµÑ€ÐµÑ‡Ð¸ÑÐ»Ð¸ Ð²ÑÐµ Ð½Ð°Ð·Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑÑ„ÐµÑ€Ñ‹)
2. **Ð“Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚ÑŒ** (Ð¥Ð¾Ð»Ð¾Ð´Ð½Ñ‹Ð¹/Ð¢ÐµÐ¿Ð»Ñ‹Ð¹/Ð“Ð¾Ñ€ÑÑ‡Ð¸Ð¹ - Ð¾Ð±ÑŠÑÑÐ½Ð¸ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ)
3. **Ð‘Ð¾Ð»Ð¸/Ð—Ð°Ð´Ð°Ñ‡Ð¸** (Ñ‡Ñ‚Ð¾ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ñ…Ð¾Ñ‡ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ)
4. **Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ñ** (ÐºÐ°ÐºÐ¸Ðµ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ, ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ñ Ð·Ð²Ð¾Ð½ÐºÐ°)

ÐžÐ±ÑŠÐµÐ¼: 150-200 ÑÐ»Ð¾Ð². Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Markdown."""

        messages = [{"role": "system", "content": summary_prompt}]
        
        for msg in history:
            role = "user" if msg.get("sender") == "user" else "assistant"
            messages.append({"role": role, "content": msg.get("text", "")})

        try:
            response = await self.client.chat.completions.create(model=self.model, messages=messages, max_tokens=1000, temperature=0.3)
            return response.choices[0].message.content or "ÐÐµÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ…"
        except:
            return "ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑÐ²Ð¾Ð´ÐºÐ¸"

    async def extract_contact_info(self, history: List[Dict[str, str]]) -> Dict[str, str]:
        if not self.client or not history:
            return {"name": None, "phone": None}

        extraction_prompt = """Analyze the conversation and extract the user's Name and Phone number.
        
        Rules:
        1. Name: Look for self-introduction or response to "What is your name?".
        2. Phone: Look for 10-12 digit number (ignoring spaces/dashes).
        3. Output ONLY JSON format: {"name": "extracted_name", "phone": "extracted_phone"}
        4. If missing, use null.
        5. IMPORTANT: Return ONLY the JSON, nothing else.
        """

        messages = [{"role": "system", "content": extraction_prompt}]
        
        for msg in history[-20:]:
            role = "user" if msg.get("sender") == "user" else "assistant"
            messages.append({"role": role, "content": msg.get("text", "")})

        try:
            # NO response_format - model doesn't support it
            response = await self.client.chat.completions.create(
                model=self.model, 
                messages=messages, 
                max_tokens=100, 
                temperature=0.1
            )
            
            import json
            import re
            
            content = response.choices[0].message.content.strip()
            print(f">>> MODEL RETURNED: {content}")
            
            # Try direct JSON parse
            try:
                result = json.loads(content)
                return {"name": result.get("name"), "phone": result.get("phone")}
            except:
                pass
            
            # Try extracting JSON from markdown
            if "```json" in content:
                content = content.split("```json")[1].split("```")[0].strip()
            elif "```" in content:
                content = content.split("```")[1].split("```")[0].strip()
            
            # Try parsing again
            try:
                result = json.loads(content)
                return {"name": result.get("name"), "phone": result.get("phone")}
            except:
                pass
            
            # Fallback: regex extraction from text
            name = None
            phone = None
            
            name_match = re.search(r'"?name"?\s*:\s*"?([^,"}\n]+)"?', content, re.IGNORECASE)
            if name_match:
                name = name_match.group(1).strip(' "\'')
                if name.lower() in ['null', 'none', '']:
                    name = None
            
            phone_match = re.search(r'"?phone"?\s*:\s*"?([^,"}\n]+)"?', content, re.IGNORECASE)
            if phone_match:
                phone = phone_match.group(1).strip(' "\'')
                if phone.lower() in ['null', 'none', '']:
                    phone = None
            
            return {"name": name, "phone": phone}
            
        except Exception as e:
            print(f"Extraction error: {e}")
            return {"name": None, "phone": None}

ai_service = AIService()
