## BizDNAi Integrations - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

# üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º—É–ª—å—Ç–∏–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ CRM —Å–∏—Å—Ç–µ–º (Bitrix24, KOMMO) —Å 1–°:–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è —á–µ—Ä–µ–∑ OData.

üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    BizDNAi Platform                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ
‚îÇ  ‚îÇ   Bitrix24   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   Webhook    ‚îÇ                ‚îÇ
‚îÇ  ‚îÇ     CRM      ‚îÇ         ‚îÇ   Endpoint   ‚îÇ                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îÇ
‚îÇ                                   ‚îÇ                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îÇ                         ‚îÇ
‚îÇ  ‚îÇ   KOMMO      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                         ‚îÇ
‚îÇ  ‚îÇ     CRM      ‚îÇ         FastAPI Server                   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         (port 8008)                      ‚îÇ
‚îÇ                                   ‚îÇ                         ‚îÇ
‚îÇ                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ                          ‚îÇ  Middleware     ‚îÇ               ‚îÇ
‚îÇ                          ‚îÇ  Integration    ‚îÇ               ‚îÇ
‚îÇ                          ‚îÇ  Logic          ‚îÇ               ‚îÇ
‚îÇ                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ                                   ‚îÇ                         ‚îÇ
‚îÇ                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ                          ‚îÇ   1–° OData      ‚îÇ               ‚îÇ
‚îÇ                          ‚îÇ   Client        ‚îÇ               ‚îÇ
‚îÇ                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
‚îÇ                                   ‚îÇ                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                    ‚îÇ
                          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                          ‚îÇ  1–°:–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è   ‚îÇ
                          ‚îÇ  OData Endpoint   ‚îÇ
                          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Telegram Bot (Polling) ‚îÄ‚îÄ‚ñ∂ Analytics Service ‚îÄ‚îÄ‚ñ∂ CRM API

üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

/root/dnai-sales/
‚îî‚îÄ‚îÄ integrations/
    ‚îú‚îÄ‚îÄ shared/                         # –û–±—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    ‚îÇ   ‚îú‚îÄ‚îÄ analytics_service.py        # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–¥–∞–∂
    ‚îÇ   ‚îú‚îÄ‚îÄ README.md                   # –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
    ‚îÇ   ‚îî‚îÄ‚îÄ __init__.py
    ‚îÇ
    ‚îî‚îÄ‚îÄ clients/                        # –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
        ‚îú‚îÄ‚îÄ morozov/                    # –ö–ª–∏–µ–Ω—Ç 1: Bitrix24 ‚Üî 1–°
        ‚îÇ   ‚îú‚îÄ‚îÄ .env                    # ‚ùå –ù–ï –≤ Git!
        ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
        ‚îÇ   ‚îú‚îÄ‚îÄ server.py               # FastAPI webhook
        ‚îÇ   ‚îú‚îÄ‚îÄ bitrix24_client.py      # Bitrix24 API
        ‚îÇ   ‚îú‚îÄ‚îÄ onec_client.py          # 1–° OData
        ‚îÇ   ‚îú‚îÄ‚îÄ analytics_bot.py        # Telegram –±–æ—Ç
        ‚îÇ   ‚îî‚îÄ‚îÄ logs/
        ‚îÇ
        ‚îî‚îÄ‚îÄ kommo/                      # –ö–ª–∏–µ–Ω—Ç 2 (–±—É–¥—É—â–∏–π)

‚öôÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)

Bitrix24

BITRIX24_WEBHOOK_URL=https://company.bitrix24.ru/rest/1/xxxxx/

–ü–æ–ª—É—á–µ–Ω–∏–µ: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí –í–µ–±—Ö—É–∫–∏ ‚Üí –í—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bitrix24_client.py - –≤—Å–µ API –∑–∞–ø—Ä–æ—Å—ã

1–° OData

ONEC_BASE_URL=http://2.133.147.210:8081/company_Technology

ONEC_USERNAME=odata.user

ONEC_PASSWORD=@Technology26

–§–æ—Ä–º–∞—Ç: http://IP:PORT/–±–∞–∑–∞_–¥–∞–Ω–Ω—ã—Ö

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: onec_client.py - –Ω–∞–∫–ª–∞–¥–Ω—ã–µ, –æ—Å—Ç–∞—Ç–∫–∏

PostgreSQL

DATABASE_URL=postgresql+asyncpg://user:pass@host/db

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –•—Ä–∞–Ω–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞, –ª–æ–≥–æ–≤

Telegram

TELEGRAM_BOT_TOKEN=7622964199:AAF_xxxxx

TELEGRAM_CHAT_ID=803934700

–ü–æ–ª—É—á–µ–Ω–∏–µ: @BotFather –∏ @userinfobot
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞

–®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
cd /root/dnai-sales/integrations/clients
mkdir –Ω–æ–≤—ã–π_–∫–ª–∏–µ–Ω—Ç && cd –Ω–æ–≤—ã–π_–∫–ª–∏–µ–Ω—Ç

–®–∞–≥ 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
cp -r ../morozov/*.py ./
cp ../morozov/docker-compose.yml ./
cp ../morozov/Dockerfile ./
cp ../morozov/requirements.txt ./

–®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ .env
cat > .env << 'EOF'
BITRIX24_WEBHOOK_URL=https://–Ω–æ–≤—ã–π-–∫–ª–∏–µ–Ω—Ç.bitrix24.ru/rest/1/xxxxx/
ONEC_BASE_URL=http://1c-server:8080/–±–∞–∑–∞
ONEC_USERNAME=user
ONEC_PASSWORD=pass
DATABASE_URL=postgresql+asyncpg://–Ω–æ–≤—ã–π:pass@localhost/–Ω–æ–≤—ã–π_db
TELEGRAM_BOT_TOKEN=123:ABC
TELEGRAM_CHAT_ID=123456
EOF

–®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ docker-compose.yml
–ò–∑–º–µ–Ω–∏—Ç—å:

container_name: –Ω–æ–≤—ã–π_–∫–ª–∏–µ–Ω—Ç_middleware
ports: - "8009:8009" (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—Ç!)
command: uvicorn server:app --host 0.0.0.0 --port 8009
–®–∞–≥ 5: –ó–∞–ø—É—Å–∫
mkdir logs
docker-compose up -d --build
nohup python3 analytics_bot.py > logs/analytics_bot.log 2>&1 &
üì± Telegram –±–æ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
–ú–µ–Ω—é
üìà –°—Ç–∞—Ç—É—Å - –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
üí∞ –î–µ–Ω—å - –ü—Ä–æ–¥–∞–∂–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è
üí∞ –ù–µ–¥–µ–ª—è - –ü—Ä–æ–¥–∞–∂–∏ –∑–∞ 7 –¥–Ω–µ–π
üí∞ –ú–µ—Å—è—Ü - –ü—Ä–æ–¥–∞–∂–∏ –∑–∞ 30 –¥–Ω–µ–π
üèÜ –¢–æ–≤–∞—Ä—ã –Ω–µ–¥–µ–ª–∏ - –¢–æ–ø-5 (7 –¥–Ω–µ–π)
üèÜ –¢–æ–≤–∞—Ä—ã –º–µ—Å—è—Ü–∞ - –¢–æ–ø-5 (30 –¥–Ω–µ–π)
–ü—Ä–∏–º–µ—Ä –æ—Ç—á—ë—Ç–∞
üí∞ –ü—Ä–æ–¥–∞–∂–∏ –∑–∞ –º–µ—Å—è—Ü
üìÖ 2025-12-12 ‚Äî 2026-01-11
üìä –û–±—â–∞—è —Å—É–º–º–∞: 2,807,520 ‚Ç∏
üì¶ –°–¥–µ–ª–æ–∫: 14
üë• –ú–µ–Ω–µ–¥–∂–µ—Ä—ã:
1. –û–ª—å–≥–∞ ‚Äî 1,935,482 ‚Ç∏ (10 —Å–¥.)
2. –ï–ª–µ–Ω–∞ ‚Äî 872,037 ‚Ç∏ (4 —Å–¥.)
üîÑ –ü—Ä–æ—Ü–µ—Å—Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
–°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–∫–ª–∞–¥–Ω–æ–π –≤ 1–°
Bitrix24: –°–¥–µ–ª–∫–∞ ‚Üí "Won"
    ‚Üì
Webhook ‚Üí /webhook/bitrix24/deal
    ‚Üì
server.py: process_deal_to_1c()
    ‚Üì
bitrix24_client: get_deal()
    ‚Üì
onec_client: create_order()
    ‚Üì
1–° OData: POST Document_–†–µ–∞–ª–∏–∑–∞—Ü–∏—è–¢–æ–≤–∞—Ä–æ–≤–£—Å–ª—É–≥
    ‚Üì
Bitrix24: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π "–ù–∞–∫–ª–∞–¥–Ω–∞—è ‚Ññ37 —Å–æ–∑–¥–∞–Ω–∞"
    ‚Üì
Telegram: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä—É
–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞—Ç–∫–æ–≤
Cron (00:00)
    ‚Üì
sync_service: get_stock_balances()
    ‚Üì
bitrix24_client: update_product_quantity()
    ‚Üì
Telegram: –û—Ç—á—ë—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

üîå KOMMO CRM Integration
–û—Ç–ª–∏—á–∏—è –æ—Ç Bitrix24
–ü–∞—Ä–∞–º–µ—Ç—Ä	Bitrix24	KOMMO
–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è	Webhook	OAuth 2.0
API	{webhook}/{method}	https://{subdomain}.kommo.com/api/v4/
–°–¥–µ–ª–∫–∏	crm.deal.*	/api/v4/leads
–õ–∏–º–∏—Ç—ã	–ù–µ—Ç	7 req/sec
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
Subdomain (–Ω–∞–ø—Ä–∏–º–µ—Ä: mycompany)
Client ID
Client Secret
Refresh Token (—á–µ—Ä–µ–∑ OAuth)
–ü—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ KOMMO

# –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
https://www.amocrm.ru/oauth?client_id=ID&state=random&mode=post_message

# –®–∞–≥ 2: –û–±–º–µ–Ω—è—Ç—å –Ω–∞ —Ç–æ–∫–µ–Ω—ã
curl -X POST https://mycompany.kommo.com/oauth2/access_token \
  -d "client_id=ID" \
  -d "client_secret=SECRET" \
  -d "grant_type=authorization_code" \
  -d "code=CODE" \
  -d "redirect_uri=https://example.com"

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å refresh_token –≤ .env!
.env –¥–ª—è KOMMO
KOMMO_SUBDOMAIN=mycompany
KOMMO_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
KOMMO_CLIENT_SECRET=xxxxxxxxxx
KOMMO_REFRESH_TOKEN=def502000xxxxx
kommo_client.py (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
class KommoClient:
    def __init__(self):
        self.base_url = f"https://{settings.kommo_subdomain}.kommo.com/api/v4"
        self.access_token = None
    
    async def _refresh_token(self):
        # POST /oauth2/access_token
        # grant_type=refresh_token
        pass
    
    async def get_lead(self, lead_id: int):
        return await self._call("GET", f"/leads/{lead_id}")
    
    async def get_won_leads(self, date_from, date_to):
        return await self._call("GET", "/leads", params={
            "filter[status_id]": 142,  # –£—Å–ø–µ—à–Ω–æ
            "filter[closed_at][from]": date_from
        })
–û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏–º–∏—Ç–æ–≤ KOMMO
async def _call(self, method, endpoint, **kwargs):
    response = await self.client.request(method, url, **kwargs)
    if response.status_code == 429:
        await asyncio.sleep(1)  # Retry —á–µ—Ä–µ–∑ 1 —Å–µ–∫
        return await self._call(method, endpoint, **kwargs)
    return response.json()

üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
–¢–∞–±–ª–∏—Ü—ã PostgreSQL
-- –õ–æ–≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
CREATE TABLE bitrix_1c_sync_log (
    id SERIAL PRIMARY KEY,
    sync_type VARCHAR(50),
    status VARCHAR(20),
    details JSONB,
    created_at TIMESTAMP DEFAULT NOW()
);
-- –°–Ω–∏–º–∫–∏ –æ—Å—Ç–∞—Ç–∫–æ–≤
CREATE TABLE bitrix_1c_stock_snapshot (
    id SERIAL PRIMARY KEY,
    product_id VARCHAR(100),
    quantity DECIMAL(10,2),
    snapshot_date DATE
);
-- –ú–∞–ø–ø–∏–Ω–≥ —Ç–æ–≤–∞—Ä–æ–≤
CREATE TABLE bitrix_1c_product_mapping (
    id SERIAL PRIMARY KEY,
    bitrix24_product_id VARCHAR(100),
    onec_product_code VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW()
);
üõ† Troubleshooting
Docker –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
docker logs bitrix_1c_middleware
docker-compose down && docker-compose up -d --build
Telegram –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
ps aux | grep analytics_bot
tail -50 logs/analytics_bot.log
pkill -f analytics_bot
nohup python3 analytics_bot.py > logs/analytics_bot.log 2>&1 &
1–° –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
curl -u "user:pass" "http://1c:8080/base/odata/standard.odata/"
–ê–≤—Ç–æ—Ä: BizDNAi Development Team
–î–∞—Ç–∞: 11 —è–Ω–≤–∞—Ä—è 2026
–í–µ—Ä—Å–∏—è: 2.0

Integration Setup - BizDNAi System Architecture
üèó System Components

1. SuperAdmin Bot
Location: /root/dnai-sales/bot/superadmin_bot.py
Process: Runs on HOST via nohup python3 superadmin_bot.py &
Logs: /tmp/superadmin.log
API: http://localhost:8005 (backend)

2. Backend API
Location: /root/dnai-sales/backend/
Process: Docker container bizdnaii_backend
Port: 8005:8000
Database: PostgreSQL on DigitalOcean

3. Client Middleware (e.g., Morozov)
Location: /root/dnai-sales/integrations/clients/morozov/
Process: Docker container bitrix_1c_middleware
Port: 8008
Purpose: Bitrix24 ‚Üî 1C integration

‚öôÔ∏è Configuration Flow
OLD (DEPRECATED ‚ùå)
Middleware reads .env ‚Üí Hardcoded credentials

NEW (ACTIVE ‚úÖ)
SuperAdmin Bot ‚Üí Backend API ‚Üí PostgreSQL ‚Üí Middleware loads from DB
üîå Setup Integration for New Client
Step 1: Configure via SuperAdmin Bot
Telegram ‚Üí SuperAdmin bot
üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí Select company
‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å ‚Üí Choose CRM type
Enter:
1C: URL, username, password
Bitrix24: webhook URL
OR KOMMO: subdomain, client_id, client_secret, refresh_token

‚úÖ Settings saved to PostgreSQL
Step 2: Create Client Middleware

# Copy template
cp -r /root/dnai-sales/integrations/clients/morozov \
      /root/dnai-sales/integrations/clients/NEW_CLIENT
cd /root/dnai-sales/integrations/clients/NEW_CLIENT

# Update config.py - ONLY change company_id
vi config.py

# Change: self.company_id = 7  ‚Üí  self.company_id = <NEW_ID>

# Create .env with ONLY DATABASE_URL
cat > .env << 'EOF'
DATABASE_URL=postgresql+asyncpg://USER:PASS@HOST:PORT/DB?ssl=require
EOF

# Update docker-compose.yml
vi docker-compose.yml

# Change: container_name, ports

# Start
docker-compose up -d

# Verify
docker logs <container_name> | grep "Loaded from DB"

# Expected: "‚úÖ Loaded from DB successfully!"
üóÑ Database Schema
companies Table - Integration Fields
integration_enabled BOOLEAN DEFAULT FALSE
integration_type VARCHAR  -- 'bitrix24', 'kommo', 'amocrm'
-- 1C OData
onec_enabled BOOLEAN DEFAULT FALSE
onec_base_url VARCHAR
onec_username VARCHAR
onec_password VARCHAR
-- Bitrix24
bitrix24_webhook_url VARCHAR
-- KOMMO/AmoCRM
kommo_subdomain VARCHAR
kommo_client_id VARCHAR
kommo_client_secret VARCHAR
kommo_refresh_token TEXT
üö® Critical Issues & Solutions
Issue 1: API returns integration_enabled: null
Problem: Backend didn't restart after models.py update
Solution:

docker-compose restart backend
Issue 2: Middleware uses empty fallback
Problem: /companies/all endpoint doesn't return integration fields
Solution: Check sales_agent.py includes integration fields in return dict

Issue 3: Settings not saved to DB
Problem: /company/upsert endpoint doesn't process integration fields
Solution: Add if 'integration_enabled' in data: blocks in upsert handler

Issue 4: Changes not in container
Problem: Docker cached old files
Solution:

docker-compose down
docker-compose build --no-cache
docker-compose up -d

‚úÖ Verification Checklist

# 1. Database
psql -h <HOST> -U <USER> -d <DB> -c \
  "SELECT integration_enabled, integration_type FROM companies WHERE id=7;"

# Expected: t | bitrix24

# 2. API
curl http://localhost:8005/sales/companies/all | jq '.[] | select(.id==7)'

# Should return integration fields

# 3. Middleware logs
docker logs <container> | grep "Loaded from DB"

# Expected: "‚úÖ Loaded from DB successfully!"
üìù Modified Files (Jan 11, 2026)
backend/models.py - Added 11 integration fields to Company model
backend/routers/sales_agent.py - Updated /company/upsert and /companies/all endpoints
bot/superadmin_bot.py - Added IntegrationFlow FSM states and handlers
integrations/clients/morozov/config.py - Loads from DB via API
üîÑ Restart Commands

# Backend
cd /root/dnai-sales
docker-compose restart backend

# SuperAdmin Bot
pkill -f superadmin_bot
cd /root/dnai-sales/bot
nohup python3 superadmin_bot.py > /tmp/superadmin.log 2>&1 &

# Middleware (e.g., Morozov)
cd /root/dnai-sales/integrations/clients/morozov
docker-compose restart
Last Updated: January 11, 2026
Duration: 2 hours (40 min bot + 80 min migration)
Status: ‚úÖ Production - All integrations from Database

# Widget ‚Üí CRM Integration (Bitrix24)
–ß—Ç–æ –¥–µ–ª–∞–µ—Ç
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ª–∏–¥—ã –∏–∑ –≤–∏–¥–∂–µ—Ç–æ–≤ (Instagram, Web –∏ –¥—Ä.) –≤ CRM –∫–ª–∏–µ–Ω—Ç–∞ (Bitrix24).

–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö
–í–∏–¥–∂–µ—Ç ‚Üí –î–∏–∞–ª–æ–≥ —Å AI ‚Üí –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ‚Üí –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Bitrix24
–ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ Bitrix24
–ö–æ–Ω—Ç–∞–∫—Ç (crm.contact.add):

–ò–º—è
–¢–µ–ª–µ—Ñ–æ–Ω
–°–¥–µ–ª–∫–∞ (crm.deal.add):

–ù–∞–∑–≤–∞–Ω–∏–µ: –õ–∏–¥ —Å Widget #XX - –ò–º—è
–°—Ç–∞–¥–∏—è: NEW
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: AI –∞–Ω–∞–ª–∏–∑ –¥–∏–∞–ª–æ–≥–∞ (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, –∏–Ω—Ç–µ—Ä–µ—Å—ã, –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ)
–ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–æ–Ω—Ç–∞–∫—Ç—É
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π
–î–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–≤ Telegram –±–æ—Ç–µ)
–ö–Ω–æ–ø–∫–∞ üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è CRM –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (–≤–∫–ª—é—á–µ–Ω–∞/–≤—ã–∫–ª—é—á–µ–Ω–∞)
Inline –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è ON/OFF
–ú–£–õ–¨–¢–ò–¢–ï–ù–ê–ù–°–ò: –∫–∞–∂–¥–∞—è –∫–æ–º–ø–∞–Ω–∏—è —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–µ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –æ—Ç–¥–µ–ª—å–Ω–æ
–î–ª—è SuperAdmin
–ö–æ–º–∞–Ω–¥–∞ ‚öôÔ∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
–í—ã–±—Ä–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å:
integration_type: bitrix24
bitrix24_webhook_url: webhook URL
integration_enabled: true/false
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Bitrix24 Webhook
–§–æ—Ä–º–∞—Ç URL:
https://COMPANY.bitrix24.kz/rest/USER_ID/WEBHOOK_KEY/
–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å:
Bitrix24 ‚Üí –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Üí –í–µ–±—Ö—É–∫–∏ ‚Üí –í—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞: crm.contact.add, crm.deal.add
–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å URL
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞
Backend (backend/routers/sales_agent.py)
–§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Å—Ç—Ä–æ–∫–∞ ~61):

async def send_lead_to_bitrix24(lead_id: int, company_id: int, db: AsyncSession):
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç integration_enabled –∏ integration_type
    # 2. –ü–æ–ª—É—á–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
    # 3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç AI summary
    # 4. –°–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç –≤ Bitrix24
    # 5. –°–æ–∑–¥–∞–µ—Ç —Å–¥–µ–ª–∫—É —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –∫–æ–Ω—Ç–∞–∫—Ç—É
–í—ã–∑–æ–≤ (—Å—Ç—Ä–æ–∫–∞ ~510):

# –ü–æ—Å–ª–µ background_send_notifications - –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
asyncio.create_task(send_lead_to_bitrix24(lead_id, company_id, db))
Bot (bot/handlers.py)
–ö–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é:

def get_manager_keyboard():
    # ...
    [KeyboardButton(text="üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è CRM")],
Handler (–≤ process_manager_command):

elif '–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è' in text_lower or 'crm' in text_lower:
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ inline –∫–Ω–æ–ø–∫—É toggle
Callback toggle:

@router.callback_query(F.data == "toggle_crm_integration")
async def toggle_crm_integration_callback(callback):
    # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç integration_enabled —á–µ—Ä–µ–∑ API
Database (Company model)
# backend/models.py - Company table
integration_enabled: bool       # ON/OFF –¥–ª—è CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
integration_type: str           # 'bitrix24', 'kommo', etc.
bitrix24_webhook_url: str       # Webhook URL –¥–ª—è Bitrix24
API Endpoints
–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–º–ø–∞–Ω–∏–π:
GET /sales/companies/all
Response: [{id, integration_enabled, integration_type, bitrix24_webhook_url, ...}]

–û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
POST /sales/company/upsert
{"id": company_id, "integration_enabled": true}
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é:

–ß–µ—Ä–µ–∑ –±–æ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞: –∫–Ω–æ–ø–∫–∞ üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è CRM ‚Üí –í–∫–ª—é—á–∏—Ç—å
–ò–ª–∏ —á–µ—Ä–µ–∑ SuperAdmin: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Üí –∫–æ–º–ø–∞–Ω–∏—è ‚Üí –≤–∫–ª—é—á–∏—Ç—å
–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ª–∏–¥:

https://bizdnai.com/w/{company_id}/{widget_id}
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:

docker-compose logs backend | grep -E "Bitrix24|DEAL"
–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Bitrix24:

–†–∞–∑–¥–µ–ª –°–¥–µ–ª–∫–∏ ‚Üí –Ω–æ–≤–∞—è —Å–¥–µ–ª–∫–∞
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç AI –∞–Ω–∞–ª–∏–∑
Troubleshooting
–õ–∏–¥ –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –≤ Bitrix24
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏
curl -s http://localhost:8000/sales/companies/all | python3 -c "
import sys, json
data = json.load(sys.stdin)
for c in data:
    if c.get('integration_enabled'):
        print(f\"Company {c['id']}: enabled={c['integration_enabled']}, type={c['integration_type']}, webhook={'YES' if c.get('bitrix24_webhook_url') else 'NO'}\")"
–û—à–∏–±–∫–∞ "asyncio not defined"
grep "^import asyncio" backend/routers/sales_agent.py
# –ï—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ import logging
–î—É–±–ª–∏–∫–∞—Ç—ã –ª–∏–¥–æ–≤ –≤ Bitrix24
–í—ã–∑–æ–≤ send_lead_to_bitrix24 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ background_send_notifications, –Ω–µ –ø–æ—Å–ª–µ get_or_create_lead.

–û—à–∏–±–∫–∞ 429 (Rate limit)
AI summary –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—ã–∑–æ–≤ –∏–¥–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.

–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã
–û–¥–∏–Ω –ª–∏–¥ = –æ–¥–Ω–∞ —Å–¥–µ–ª–∫–∞ - –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
–ú–£–õ–¨–¢–ò —Ä–µ–∂–∏–º - –∫–∞–∂–¥–∞—è –∫–æ–º–ø–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
AI –∞–Ω–∞–ª–∏–∑ - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–¥–µ–ª–∫–∏
–ö–æ–Ω—Ç–∞–∫—Ç + –°–¥–µ–ª–∫–∞ - —Å–æ–∑–¥–∞—é—Ç—Å—è –æ–±–∞ –æ–±—ä–µ–∫—Ç–∞, —Å–≤—è–∑–∞–Ω—ã –º–µ–∂–¥—É —Å–æ–±–æ–π
