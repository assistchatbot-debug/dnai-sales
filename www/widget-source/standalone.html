<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizDNAi Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .recording { background: #ef4444 !important; animation: pulse 1.5s infinite; }
        .sticky-logo { position: sticky; top: 20px; z-index: 50; background: rgba(99, 102, 241, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        select option { background-color: #1f2937; color: white; }
        select option:hover { background-color: #374151; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen p-4">
    <div class="flex flex-col items-center min-h-screen gap-6 pt-8">
        <div class="sticky-logo w-40 h-40 rounded-full shadow-2xl flex items-center justify-center">
            <img id="mainLogo" src="https://bizdnai.com/logo.png" class="w-32 h-32 rounded-full bg-white p-2">
        </div>
        <div class="text-center -mt-6">
            <h1 id="companyName" class="text-3xl font-bold text-white mb-2">BizDNAi</h1>
            <p id="companyDesc" class="text-white/90 text-lg max-w-md mx-auto mb-8 whitespace-pre-line"></p>
        </div>
        <div class="w-full max-w-md h-[600px] bg-slate-800 rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-slate-700 mb-8">
            <div class="bg-indigo-600 p-3">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <img id="logo" src="https://bizdnai.com/logo.png" class="w-8 h-8 rounded-full" alt="Logo">
                        <div>
                            <h3 id="headerName" class="font-bold text-sm text-white">BizDNAi</h3>
                            <span class="text-xs text-green-300 flex items-center gap-1">‚óè Online</span>
                        </div>
                    </div>
                    <button onclick="resetChat()" class="hover:bg-white/10 p-1 rounded text-white text-lg">üîÑ</button>
                </div>
                <select id="langSelect" class="w-full p-2 rounded-lg bg-indigo-500/20 border border-indigo-400/40 text-white text-sm">
                    <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="en">üá∫üá∏ English</option>
                    <option value="kz">üá∞üáø “ö–∞–∑–∞“õ—à–∞</option>
                    <option value="kg">üá∞üá¨ –ö—ã—Ä–≥—ã–∑—á–∞</option>
                    <option value="uz">üá∫üáø O'zbekcha</option>
                    <option value="ua">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                </select>
            </div>
            <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-800"></div>
            <div id="typing" class="hidden px-4 py-2"><div class="flex gap-1 items-center"><div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce"></div><div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div><div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div></div></div>
            <div class="p-3 bg-slate-900 border-t border-slate-700"><div class="flex gap-2 items-end"><textarea id="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." rows="1" class="flex-1 bg-slate-700 text-white rounded-2xl px-4 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea><button id="voiceBtn" class="flex-shrink-0 w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center text-white transition-colors touch-none">üé§</button><button onclick="sendMsg()" class="flex-shrink-0 w-10 h-10 rounded-full bg-indigo-600 hover:bg-indigo-500 flex items-center justify-center text-white transition-colors">‚û§</button></div></div>
        </div>
    </div>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        // Parse URL: /w/{company_id}/{channel_name}
        const pathParts = window.location.pathname.split('/').filter(p => p);
        let companyId = '1';
        let channelName = null;
        
        if (pathParts[0] === 'w' && pathParts.length >= 2) {
            companyId = pathParts[1];
            channelName = pathParts[2] || null;
        } else {
            // Fallback to query params
            companyId = urlParams.get('company') || '1';
        }
        const API = `/sales/${companyId}`;
        let sessionId = null;
        let visitorId = localStorage.getItem('bizdnaii_vid') || 'v_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('bizdnaii_vid', visitorId);
        const langMap = { ru: 'ru', en: 'en', kz: 'kz', kg: 'ky', uz: 'uz', ua: 'uk' };
        // Default greetings (fallback)
        const defaultGreetings = { 
            ru: '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\n–Ø —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ BizDNAi.\n\n–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å–∞: –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥, –§–∏–Ω–∞–Ω—Å—ã, –ü—Ä–æ–¥–∞–∂–∏...', 
            en: 'Hello!\nI am the smart assistant of BizDNAi.',
            kz: '–°”ô–ª–µ–º–µ—Ç—Å—ñ–∑ –±–µ!\n–ú–µ–Ω BizDNAi –∞“õ—ã–ª–¥—ã –∫”©–º–µ–∫—à—ñ—Å—ñ–º—ñ–Ω.',
        };
        let customGreeting = null;
        let customGreetings = null;
        
        // Load widget-specific greeting and initialize
        async function loadWidgetConfig() {
            if (channelName) {
                try {
                    const response = await fetch(`/sales/companies/${companyId}/widgets/${channelName}`);
                    if (response.status === 404 || response.status === 405) {
                        document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;"><h2>‚ùå –í–∏–¥–∂–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</h2></div>';
                        return;
                    }
                    const data = await response.json();
                    if (data.greetings) {
                    // Load all language greetings
                    window.customGreetings = data.greetings;
                    const mappedLang = langMap[langSelect.value] || langSelect.value;
                    customGreeting = data.greetings[mappedLang] || data.greetings.ru || data.greeting_message;
                    console.log('‚úÖ Loaded greetings:', Object.keys(data.greetings));
                } else if (data.greeting_message) {
                    customGreeting = data.greeting_message;
                }
                } catch (e) {
                    console.log('No custom greeting, using default');
                }
            }
            // Initialize chat AFTER loading greeting
            resetChat();
        }
        
        // Call the function
        loadWidgetConfig();
        loadWidgetConfig();
        
        fetch(`${API}/company-info`).then(r => r.json()).then(data => {
            console.log('Company data:', data);
            if (data.logo_url) { mainLogo.src = data.logo_url; logo.src = data.logo_url; }
            if (data.company_name) { companyName.textContent = data.company_name; headerName.textContent = data.company_name; }
            if (data.descriptions) {
                window.companyDescriptions = data.descriptions;
                const mappedLang = langMap[langSelect.value] || langSelect.value;
                companyDesc.textContent = data.descriptions[mappedLang] || data.descriptions.ru;
            } else if (data.description) {
                companyDesc.textContent = data.description;
            } else {
                companyDesc.textContent = '‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ SuperAdmin –±–æ—Ç–∞';
            }
        }).catch(e => { console.error('Load failed:', e); companyDesc.textContent = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö'; });
        
        function addMsg(text, isUser) { const div = document.createElement('div'); div.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`; div.innerHTML = `<div class="max-w-[80%] px-4 py-2 rounded-2xl whitespace-pre-line ${isUser ? 'bg-indigo-600 text-white' : 'bg-slate-700 text-white'}">${text}</div>`; messages.appendChild(div); messages.scrollTop = messages.scrollHeight; }
        async function sendMsg() { const text = input.value.trim(); if (!text) return; addMsg(text, true); input.value = ''; typing.classList.remove('hidden'); try { const res = await fetch(`${API}/chat`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: text, session_id: sessionId, user_id: visitorId, language: langMap[langSelect.value] || 'ru', source: channelName || 'web' }) }); const data = await res.json(); if (data.session_id) sessionId = data.session_id; addMsg(data.response, false); } catch (e) { addMsg('‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏', false); } finally { typing.classList.add('hidden'); } }
        function resetChat() { visitorId = 'v_' + Math.random().toString(36).substr(2, 9); localStorage.setItem('bizdnaii_vid', visitorId); sessionId = null; messages.innerHTML = ''; addMsg(customGreeting || defaultGreetings[langSelect.value] || defaultGreetings.ru, false); }
        let mediaRecorder, audioChunks, isRecording = false;
        voiceBtn.addEventListener('pointerdown', async (e) => { e.preventDefault(); if (isRecording) return; try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); mediaRecorder = new MediaRecorder(stream); audioChunks = []; isRecording = true; mediaRecorder.ondataavailable = e => audioChunks.push(e.data); mediaRecorder.onstop = async () => { const blob = new Blob(audioChunks, { type: 'audio/webm' }); const formData = new FormData(); formData.append('file', blob, 'voice.webm'); formData.append('session_id', sessionId || 'new'); formData.append('user_id', visitorId); formData.append('language', langMap[langSelect.value] || 'ru'); formData.append('source', channelName || 'web'); addMsg('üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ...', true); typing.classList.remove('hidden'); try { const res = await fetch(`${API}/voice`, { method: 'POST', body: formData }); const data = await res.json(); if (data.text) { const msgs = messages.querySelectorAll('.flex.justify-end'); msgs[msgs.length - 1].querySelector('div').textContent = 'üó£ ' + data.text; } if (data.response) addMsg(data.response, false); } catch (e) { addMsg('‚ùå –û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–∞', false); } finally { typing.classList.add('hidden'); } stream.getTracks().forEach(t => t.stop()); isRecording = false; }; mediaRecorder.start(); voiceBtn.classList.add('recording'); } catch (e) { addMsg('‚ùå –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', false); isRecording = false; } });
        voiceBtn.addEventListener('pointerup', (e) => { e.preventDefault(); if (mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); voiceBtn.classList.remove('recording'); } });
        voiceBtn.addEventListener('pointercancel', (e) => { if (mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); voiceBtn.classList.remove('recording'); } });
        input.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } });
        langSelect.addEventListener('change', () => {
            const mappedLang = langMap[langSelect.value] || langSelect.value;
            console.log('Language changed to:', langSelect.value, '‚Üí', mappedLang);
            // Update greeting when language changes
            if (window.customGreetings) {
                customGreeting = window.customGreetings[mappedLang] || window.customGreetings.ru;
                console.log('Updated greeting to:', customGreeting.substring(0, 50) + '...');
            }
            // Update company description
            if (window.companyDescriptions && window.companyDescriptions[mappedLang]) {
                companyDesc.textContent = window.companyDescriptions[mappedLang];
                console.log('Updated description to:', mappedLang);
            }
            resetChat();
        });
    </script>
</body>
</html>
